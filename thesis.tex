
\documentclass[12pt,a4paper,onecolumn,oneside]{memoir}
%twoside for print version
\input{0-preamble/packages.tex}
\input{0-preamble/hoepelman-pagestyle.tex}
\input{0-preamble/commands.tex}
\input{0-preamble/font.tex}

\maxsecnumdepth{subsection} % chapters, sections, and subsections are numbered
\maxtocdepth{subsection} % chapters, sections, and subsections are in the Table of Contents

\newcommand{\todo}[1]{\textbf{TODO: #1}}
\newcommand{\ignore}[1]{}
\newcommand{\f}[1]{\texttt{#1}}
\newcommand{\key}[1]{\textbf{#1}}

\begin{document}

\include{0-title/title}

\cleardoublepage

%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%
\tableofcontents*

\clearpage
%\twocolumn

%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%
%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%---%%%

\chapter{Introduction}

Like all people, I sometimes get asked what I do for a living.
When I tell someone I am writing my master thesis in Computer Science, their eyes start to glaze over as they anticipate some explanation peppered with terms they will not understand about 
I then tell them my thesis is about spreadsheets and ask if they have ever worked with Excel, and nearly everyone who has ever worked in business or research has.
Nearly everyone has a horror story about that one unmaintainable spreadsheet that they had to work on, or that day their reporting system broke down because 2009 turned into 2010 and the spreadsheet only looked at the last digit.

\vspace{0.3em}

This anecdotal evidence is mirrored in research.
Panko \cite{panko2006facing} estimates that 80\% to 95\% of businesses use spreadsheets in one of their processes.
Furthermore, almost all spreadsheets contains at least one error and 1 to 5\% of spreadsheet cells contains an error according to Panko \cite{panko1998we}.
Spreadsheets perform roles very similar to software in that they perform business-critical roles, are inherited throughout the organization and maintained by different users and accrue technical dept during and after the initial development period \cite{panko1998we}.
In short, spreadsheets can be classified as programs, and spreadsheet creators are end-user programmers.

\vspace{0.3em}

This view, "spreadsheets are code", could be the 1-sentence summary of the ideology of the Spreadsheet Lab, which is a part of the TU Delft Software Engineering Research Group (SERG).
Using this view as a baseline, the group has tried to translate tried and proven software engineering methods to the spreadsheet domain so that they could be used to improve spreadsheets, spreadsheet development practices and help spreadsheet programmers.
As part of this effort, a spreadsheet formula refactoring tool called BumbleBee was developed by Hermans and Dig \cite{hermans2014bumblebee}.
This tool allows a formula to be transformed into another by defining a transformation rule, which works very similar to a pattern or regular expression replacement in a text editor.
However this approach has the downside that it can only considers the contents of one formula, and not of the spreadsheet as a whole.
This limits the capabilities of the approach, and makes it not powerful enough to implement all spreadsheet refactorings, such as those implemented by Badame and Dig \cite{badame2012refactoring} in earlier work.
I joined the group to extend the capabilities of BumbleBee so that it could take context into account when performing refactorings, and implement more refactorings in BumbleBee.

\vspace{0.3em}

After the initial literature research I started implementing refactorings, but encountered a fundamental problem in doing so.
The standard way of implementing refactorings is by parsing the source code to an Abstract Syntax Tree (AST), which represents the structure of the program.
This AST can then be manipulated into the desired form, after which it can be converted back to source code (this is called pretty-printing).
While BumbleBee contained a home-grown parser, I found a range of formulas that were either not parsable, or parsed into an incorrect AST.
This made me refocus the purpose of my thesis into making a better parser for Excel formulas, as this would not only be very useful for implementing refactorings but would be beneficial to all future spreadsheet research projects.

The contributions of this thesis are twofold. Firstly there is the stand-alone parser for Excel formulas called XLParser, which is open-source and available online\footnote{\url{https://github.com/spreadsheetlab/XLParser}}. The parser was tested on over a million formulas and failed to parse merely two formulas.
Details of this parser are published by Aivaloglou, Hoepelman and Hermans \cite{xlparser}.
This paper is partially re-used in this thesis report, and the parts re-used are my contribution to the paper.
The second contribution is an improved version of BumbleBee, which implements the refactorings described in chapter \ref{chapter:implementingrefactorings}.
BumbleBee is also available online\footnote{TODO: URL Bumblebee.}.

\section{Thesis outline}

A passing knowledge of Excel and more in-depth knowledge of Excel formulas is needed to read the rest of this thesis.
This knowledge is bundled in chapter \ref{chapter:anatomy} "\nameref{chapter:anatomy}".
Chapter \ref{chapter:previouswork} details previous and related work on spreadsheet refactoring.
In chapter \ref{chapter:candidaterefactorings} potential spreadsheet refactorings which were not yet implemented in BumbleBee are identified.

The following chapters describe the implementation of the spreadsheet refactorings.
Chapter \ref{chapter:parsing} covers how XLParser parses spreadsheet formulas and why it was designed as it was.
Chapter \ref{chapter:implementingrefactorings} describes how spreadsheet refactorings are performed and the implementation details of the new refactorings.

\todo{Meer zodra thesis wat meer vlees heeft}

\clearpage
\section{Thesis timeline and decisions taken}

\begin{tabularx}{\textwidth}{lX}
\toprule
December 2014 & Literature study on refactoring, refactoring spreadsheets, converting spreadsheets to programs. \\
& Thesis topic selection. \\
January 2015 & Studied practicality of generic spreadsheet refactoring language based on Bumblebee transformation language, deemed inviable. \\
& Gathered existing refactorings from spreadsheet literature and translated Fowler refactorings. \\
& Decided which refactorings to initially implement \\
& Familiarization with existing BumbleBee code \\
February 2015 & Implementating of "Inline Formula" \\
& Extended Bumblebee and parser to account for sheet and file names \\
March 2015 & Implementing of "Extract formula" \\
& Writing of paper "End user programming" \todo{} \\
April 2015 & Writing of paper "End user programming" \todo{} \\
& Various improvements to parser \\
May 2015 & Decided to rewrite parser to solve several fundamental problems \\
& Implementing of Op to Agregate refactoring \\
& Implementing of Group references refactoring \\
June 2015 & Continued work on XLParser \\
& Writing of XLParser paper \\
July 2015 & Continued work on XLParser \\
& Changing of refactoring UI to context-aware right-click menu, similar to IDE's \\
August 2015 & Continued work on XLParser \\
& Camera-ready adjustment of XLParser paper \\
& Porting BumbleBee and refactorings to XLParser \\
September 2015 & Continued work on XLParser \\
& Porting BumbleBee and refactorings to XLParser-based implementations \\
\bottomrule
\end{tabularx}

%\chapter{Spreadsheet anatomy}
\include{anatomy/chapter}

\chapter{Previous and related work}
\label{chapter:previouswork}

\section{Refactoring}

\section{The BumbleBee spreadsheet refactoring suite}

\section{Other spreadsheet refactoring efforts}


\chapter{Candidate spreadsheet refactorings}
\label{chapter:candidaterefactorings}

\section{Comparing spreadsheets to other programming paradigms}

\subsection{Reactive programming}
As explained in chapter \ref{chapter:anatomy}, the spreadsheet programming model is a variation of the dataflow programming model.
Thus the most natural first comparison for spreadsheet is the \emph{reactive programming} paradigm, which is another variation of the dataflow programming model.
Viewed from the RP model, all spreadsheet cells are observable values and every formula is an observer.
One can attach a formula observer to a cell observable by making a reference, e.g. a formula \f{=A1+1} in cell B1 listens to the value of A1 and produces the value for B1.
However currently no literature on refactoring reactive programs is known to the author, so no additional refactoring were found by comparing spreadsheets to reactive programs.

\subsection{Functional programming}
Spreadsheets program do not contain state (mutable variables) or side-effects
\footnote{As long as one remains within the spreadsheet model. User-defined functions and inter-operation with external programs can cause side-effects.}
and this immutability aspect is often associated with functional programming languages.
However spreadsheets lack several other important concepts of functional languages such as first-class and higher-order functions, recursion\footnote{Most spreadsheet implementations allow for a form of recursion in the form of cycles in the dependency graph called circular references. However this is not the normal modus-operandi, triggers a warning and is generally only used to perform iterative calculations which are not otherwise possible in spreadsheets.}, lazy evaluation and type interference.

\subsection{Translation of concepts}

Some literature exist on refactoring functional programs, most prominent is the tool \textbf{Ha}skell \textbf{Re}factoring tool (HaRe) \cite{thompson2005refactoring}.
Most of the described refactorings are either specific to Haskell, or only applicable because of concepts not available in spreadsheets.

This makes all of the current literature on refactoring functional programs not applicable.
\todo{Cite functional refactoring literature}

\subsection{Object-oriented programming}

By far 



\section{Translating refactorings to the spreadsheet domain}

Tabel met mogelijke refactorings.
Subsecties voor alle geïmplementeerde refactorings.

%\chapter{Parsing spreadsheet formulas}
\include{parsing/chapter}

\chapter{Implementing refactorings}
\label{chapter:implementingrefactorings}

Parse -> Transform -> Print

\section{Transforming formula ASTs}

\section{Refactoring-specific implementation}

\subsection{Extract formula}

\subsection{Inline formula}

\subsection{Addition to SUMIF}

\subsection{\textasciicircum\textasciicircum or Aggregate to conditional Aggregate}

\subsection{Group References}

\chapter{Evaluation}


\chapter{Conclusion}

\section{Future Work}



\chapter{Appendix A: paper}

\todo{Paper hier inserten? Staat in regulaties dat dat kan (/de bedoeling is?)}

\bibliographystyle{unsrt}
\bibliography{thesis}

\end{document}

